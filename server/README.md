# DriveMerge - Server (PoC)

This folder contains the API Gateway and WebSocket server for the DriveMerge PoC. The server's PoC responsibilities:

- Expose `/api/files/create` to accept a list of chunk SHA-256 hashes and metadata for a new file.
- Maintain a small in-memory or SQLite-backed `Hashes` store to determine deduplication for PoC.
- Host a WebSocket server that broadcasts `job_ready` messages and per-chunk progress events to connected clients.
- In later milestones, act as the coordinator that queues URL generation jobs, manages per-account BullMQ queues, and handles circuit-breaker state in Redis.

Quickstart (server)

1. From monorepo root, install dependencies for the server:

```bash
cd "/Users/kammatiaditya/Downloads/DriveMerge 2/DriveMerge-Project"
yarn workspace server install
```

2. Start the server (PoC implementation will add `src/server.ts`):

```bash
cd server
yarn dev
```

Environment variables (local dev)

- Create `server/.env` (DO NOT commit this file):

```properties
CLIENT_ID=your-google-client-id.apps.googleusercontent.com
CLIENT_SECRET=your-google-client-secret
REDIRECT_URI=http://localhost:3000/auth/google/callback
PORT=3000
# In production add DATABASE_URL, REDIS_URL, and SERVER_ENCRYPTION_KEY
```

PoC details

- For the PoC we will start with a small in-memory Hash map to represent the `Hashes` table. This avoids DB setup for the first demo and makes iteration faster.
- The server will respond to `/api/files/create` with a JSON payload that contains for each chunk either `deduplicated: true` or `needs_upload: true`. For `needs_upload` chunks the server will (in PoC) return a placeholder signed URL. Later this will be replaced by real Google Drive resumable upload sessions generated by a background job.

Next work items for server

- Create `src/server.ts` with Express + WS server and a `/api/files/create` endpoint.
- Add a small `src/db/simpleHashes.ts` to simulate persistence and refCount logic.
- Later: integrate PostgreSQL (Prisma), Redis (BullMQ), and Google Drive signed URL generation.

Security and secrets

- Do not commit `CLIENT_SECRET` to source control. Rotate any secret keys if you believe they were exposed.
- Server will only store encrypted refresh tokens for linked Google accounts. It will never receive raw chunk plaintext or unwrapped chunk keys.

Contact

- See top-level README for overall project direction, PoC acceptance criteria and next milestones.
